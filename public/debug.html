<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soulo Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <h1>üîß Soulo Debug Page</h1>
    <p>This page helps diagnose WebView and JavaScript loading issues.</p>

    <div class="debug-section">
        <h2>Environment Detection</h2>
        <div id="environment-info"></div>
    </div>

    <div class="debug-section">
        <h2>Capacitor Status</h2>
        <div id="capacitor-info"></div>
    </div>

    <div class="debug-section">
        <h2>JavaScript Execution Test</h2>
        <div id="js-test-results"></div>
        <button onclick="runJavaScriptTests()">Run Tests</button>
    </div>

    <div class="debug-section">
        <h2>Network & Loading Tests</h2>
        <div id="network-test-results"></div>
        <button onclick="testNetworkAndAssets()">Test Network & Assets</button>
    </div>

    <div class="debug-section">
        <h2>Console Logs</h2>
        <div id="console-logs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="exportLogs()">Export Logs</button>
    </div>

    <div class="debug-section">
        <h2>Emergency Actions</h2>
        <button onclick="loadMainApp()">Try Load Main App</button>
        <button onclick="testBasicReact()">Test Basic React</button>
        <button onclick="forceReload()">Force Reload</button>
    </div>

    <script>
        // Console log capture
        const logs = [];
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function captureLog(type, args) {
            const timestamp = new Date().toISOString();
            const message = Array.from(args).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logs.push({ timestamp, type, message });
            updateConsoleDisplay();
            
            // Call original console method
            originalConsole[type].apply(console, args);
        }

        console.log = (...args) => captureLog('log', args);
        console.error = (...args) => captureLog('error', args);
        console.warn = (...args) => captureLog('warn', args);
        console.info = (...args) => captureLog('info', args);

        function updateConsoleDisplay() {
            const container = document.getElementById('console-logs');
            const lastLogs = logs.slice(-50); // Show last 50 logs
            container.innerHTML = lastLogs.map(log => 
                `<div class="status ${log.type === 'error' ? 'error' : log.type === 'warn' ? 'warning' : 'info'}">
                    <strong>[${log.timestamp.split('T')[1].split('.')[0]}] ${log.type.toUpperCase()}:</strong><br>
                    <pre>${log.message}</pre>
                </div>`
            ).join('');
        }

        function clearLogs() {
            logs.length = 0;
            updateConsoleDisplay();
        }

        function exportLogs() {
            const logText = logs.map(log => 
                `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `soulo-debug-logs-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function detectEnvironment() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                windowSize: `${window.innerWidth}x${window.innerHeight}`,
                screenSize: `${screen.width}x${screen.height}`,
                devicePixelRatio: window.devicePixelRatio,
                localStorage: !!window.localStorage,
                sessionStorage: !!window.sessionStorage,
                indexedDB: !!window.indexedDB,
                serviceWorker: !!navigator.serviceWorker,
                webgl: !!window.WebGLRenderingContext,
                touchSupport: 'ontouchstart' in window,
                isCapacitor: !!window.Capacitor,
                isNative: window.Capacitor ? window.Capacitor.isNativePlatform?.() : false,
                capacitorPlatform: window.Capacitor ? window.Capacitor.getPlatform?.() : 'none'
            };

            const container = document.getElementById('environment-info');
            container.innerHTML = Object.entries(info).map(([key, value]) => 
                `<div class="status info">
                    <strong>${key}:</strong> ${typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value)}
                </div>`
            ).join('');

            console.log('Environment detected:', info);
        }

        function checkCapacitor() {
            const container = document.getElementById('capacitor-info');
            
            if (!window.Capacitor) {
                container.innerHTML = '<div class="status error">‚ùå Capacitor not available</div>';
                return;
            }

            try {
                const capacitorInfo = {
                    available: true,
                    platform: window.Capacitor.getPlatform?.(),
                    isNative: window.Capacitor.isNativePlatform?.(),
                    plugins: window.Capacitor.Plugins ? Object.keys(window.Capacitor.Plugins) : [],
                    debug: window.Capacitor.DEBUG
                };

                container.innerHTML = `
                    <div class="status success">‚úÖ Capacitor Available</div>
                    <pre>${JSON.stringify(capacitorInfo, null, 2)}</pre>
                `;

                // Test specific plugins
                const pluginTests = [];
                
                if (window.Capacitor.Plugins?.Device) {
                    pluginTests.push(testDevicePlugin());
                }
                
                if (window.Capacitor.Plugins?.SplashScreen) {
                    pluginTests.push(testSplashScreenPlugin());
                }

                Promise.allSettled(pluginTests).then(results => {
                    const testResults = results.map((result, index) => 
                        result.status === 'fulfilled' 
                            ? `‚úÖ Plugin ${index + 1} OK: ${result.value}`
                            : `‚ùå Plugin ${index + 1} Failed: ${result.reason}`
                    ).join('<br>');
                    
                    container.innerHTML += `<div class="status info">Plugin Tests:<br>${testResults}</div>`;
                });

            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Capacitor Error: ${error.message}</div>`;
            }
        }

        async function testDevicePlugin() {
            const device = window.Capacitor.Plugins.Device;
            const info = await device.getInfo();
            return `Device: ${info.platform} ${info.model}`;
        }

        async function testSplashScreenPlugin() {
            // Just test if the plugin is callable
            const splash = window.Capacitor.Plugins.SplashScreen;
            return `SplashScreen plugin available`;
        }

        function runJavaScriptTests() {
            const container = document.getElementById('js-test-results');
            const tests = [];

            // Test basic JavaScript features
            try {
                // ES6 features
                const arrow = () => 'arrow functions work';
                const { test } = { test: 'destructuring works' };
                const template = `template literals work`;
                
                tests.push('‚úÖ ES6 features working');
            } catch (e) {
                tests.push(`‚ùå ES6 features failed: ${e.message}`);
            }

            // Test async/await
            try {
                (async () => {
                    await new Promise(resolve => setTimeout(resolve, 1));
                    tests.push('‚úÖ Async/await working');
                    updateTestResults();
                })();
            } catch (e) {
                tests.push(`‚ùå Async/await failed: ${e.message}`);
            }

            // Test modules
            try {
                const canUseModules = typeof import !== 'undefined';
                tests.push(canUseModules ? '‚úÖ ES modules supported' : '‚ö†Ô∏è ES modules not supported');
            } catch (e) {
                tests.push(`‚ùå Module test failed: ${e.message}`);
            }

            // Test React
            if (window.React) {
                tests.push('‚úÖ React available');
            } else {
                tests.push('‚ùå React not loaded');
            }

            function updateTestResults() {
                container.innerHTML = tests.map(test => 
                    `<div class="status ${test.includes('‚úÖ') ? 'success' : test.includes('‚ùå') ? 'error' : 'warning'}">${test}</div>`
                ).join('');
            }

            updateTestResults();
        }

        async function testNetworkAndAssets() {
            const container = document.getElementById('network-test-results');
            const tests = [];

            // Test network connectivity
            try {
                const response = await fetch('/debug.html', { method: 'HEAD' });
                tests.push(`‚úÖ Network: ${response.status} ${response.statusText}`);
            } catch (e) {
                tests.push(`‚ùå Network failed: ${e.message}`);
            }

            // Test loading main assets
            const assetTests = [
                '/index.html',
                '/assets/index.js',
                '/assets/index.css'
            ];

            for (const asset of assetTests) {
                try {
                    const response = await fetch(asset, { method: 'HEAD' });
                    tests.push(`‚úÖ Asset ${asset}: ${response.status}`);
                } catch (e) {
                    tests.push(`‚ùå Asset ${asset}: ${e.message}`);
                }
            }

            container.innerHTML = tests.map(test => 
                `<div class="status ${test.includes('‚úÖ') ? 'success' : 'error'}">${test}</div>`
            ).join('');
        }

        function loadMainApp() {
            console.log('Attempting to load main app...');
            window.location.href = '/';
        }

        function testBasicReact() {
            if (window.React && window.ReactDOM) {
                try {
                    const element = React.createElement('div', null, 'React is working!');
                    const container = document.createElement('div');
                    document.body.appendChild(container);
                    ReactDOM.render(element, container);
                    console.log('‚úÖ Basic React test successful');
                } catch (e) {
                    console.error('‚ùå Basic React test failed:', e);
                }
            } else {
                console.error('‚ùå React/ReactDOM not available');
            }
        }

        function forceReload() {
            console.log('Force reloading...');
            window.location.reload(true);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Soulo Debug page loaded');
            detectEnvironment();
            checkCapacitor();
            
            // Auto-run basic tests
            setTimeout(() => {
                runJavaScriptTests();
                testNetworkAndAssets();
            }, 1000);
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error || event.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>